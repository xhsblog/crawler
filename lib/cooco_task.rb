class CoocoTask
  def initialize(numbers)
    @numbers = numbers
    @remote = Remote.new
    @gzsxtesttest = ''
    @cookie = 'Hm_lvt_c8ad399579b4816dc8f6f805c190308=1563612961; bdshare_firstime=1563612970002; coocoold=ad5ac34818bd4b755a27ebcc6ce6d74c; gzsxtesttest=146605%2C146362%2C146607%2C292936%2C289153%2C292911%2C146473%2C145875%2C138237%2C292942%2C348708%2C292226%2C146709%2C287787%2C289792%2C146053%2C288799%2C284420%2C146318%2C146333%2C146649%2C146703%2C292951%2C292406%2C363961%2C287815%2C146536%2C292270%2C284379%2C287987%2C287406%2C284703%2C279346%2C146440%2C146608%2C285196%2C146706%2C287646%2C146715%2C145879%2C292224%2C292714%2C286393%2C146543%2C275006%2C376595%2C146403%2C146425%2C144420%2C351871%2C145478%2C287574%2C146193%2C280176%2C292681%2C146490%2C286547%2C286590%2C146482%2C146003%2C285892%2C355198%2C291988%2C290818%2C146654%2C145867%2C292676%2C146325%2C289152%2C352501%2C146716%2C144475%2C133344%2C287732%2C145763%2C292646%2C291740%2C146660%2C146387%2C287298%2C378602%2C146665%2C292566%2C142826%2C292535%2C292505%2C289764%2C288614%2C146621%2C358851%2C290018%2C145920%2C347057%2C289967%2C281203%2C282024%2C146646%2C285974%2C146611%2C274998%2C146319%2C145030%2C145023%2C137553%2C144412%2C284970%2C292683%2C292234%2C281764%2C274669%2C146383%2C346660%2C143182%2C292151%2C288287%2C145939%2C144636%2C146190%2C145702%2C146497%2C146652%2C292473%2C280644%2C141942%2C281179%2C146696%2C291716%2C365987%2C292075%2C145987%2C144612%2C146656%2C146448%2C384416%2C140318%2C146626%2C144126%2C145308%2C292677%2C280129%2C146399%2C146662%2C281640%2C281281%2C144144%2C292772%2C292486%2C280816%2C290967%2C291033%2C291164%2C284378%2C137158%2C146300%2C280016%2C290414%2C145999%2C140077%2C284181%2C136224%2C369602%2C292964%2C349261%2C292777%2C290734%2C144373%2C396614%2C146516%2C281850%2C292545%2C288800%2C287721%2C282903%2C146494%2C146211%2C279475%2C287015%2C279125%2C144813%2C357890%2C293065%2C274612%2C146496%2C286270%2C146317%2C138734%2C146419%2C292953%2C146467%2C279767%2C292515%2C285168%2C291110%2C144808%2C292958%2C288601%2C145934%2C146653%2C146647%2C292209%2C292146%2C291168%2C145019%2C372697%2C288327%2C280439%2C141854%2C291387%2C292470%2C370385%2C281091%2C283240%2C292959%2C286153%2C349412%2C284244%2C282772%2C141843%2C145923%2C146545%2C292608%2C279164%2C145303%2C282351%2C143551%2C289199%2C292415%2C279295%2C286196%2C292720%2C286024%2C292617%2C285522%2C275134%2C132106%2C145317%2C142562%2C291599%2C133855%2C371447%2C280107%2C280251%2C291315%2C383301%2C140510%2C285591%2C284331%2C292446%2C281266%2C285523%2C279427%2C146655%2C290973%2C291065%2C291668%2C276977%2C292542%2C283607%2C357728%2C292562%2C144545%2C280422%2C285338%2C352365%2C291140%2C350227%2C282053%2C292324%2C146650%2C143064%2C146474%2C145535%2C137349%2C146182%2C140319%2C292722%2C291344%2C290926%2C279999%2C279890%2C146439%2C146659%2C291210%2C280057%2C397557%2C145000%2C138724%2C291720%2C286128%2C286101%2C292930%2C140887%2C141668%2C145057%2C284481%2C280217%2C280187%2C282030%2C146616%2C146483%2C291440%2C146528%2C146717%2C347071%2C292929%2C146645%2C292564%2C291597%2C349154%2C283510%2C279382%2C275512%2C146555%2C146501%2C279539%2C379516%2C146164%2C291309%2C146619%2C279641%2C283623%2C137161%2C289806%2C281542%2C278689%2C274514%2C371837%2C281443%2C292503%2C347041%2C279506%2C285638%2C293037%2C290189%2C278454%2C286458%2C364904%2C284062%2C146468%2C146707%2C146166%2C292937%2C133163%2C281824%2C146485%2C279830%2C292661%2C290468%2C289149%2C145918%2C146614%2C289836%2C355494%2C290498%2C292516%2C292906%2C281892%2C278412%2C141203%2C143327%2C281851%2C292467%2C146698%2C146100%2C289509%2C352418%2C291452%2C280229%2C290338%2C281036%2C286021%2C145661%2C281177%2C278711%2C281733%2C144629%2C347042%2C347791%2C274064%2C145989%2C281176%2C287794%2C292172%2C145881%2C286479%2C347087%2C291579%2C347230%2C134347%2C279611%2C283487%2C401903%2C292921%2C292553%2C292786%2C347023%2C348580%2C280204%2C285318%2C283609; Hm_lpvt_c8ad39b9579b4816dc8f6f805c190308=1563757501'
  end
  # include Crawlers::Cooco

  def cookier
    
  end

  def build(path = '/maketestfinish/')
    puts "files is #{path}"
    cookie ||= set_cookie
    response = @remote.conn.post do  |req|
      req.url "http://gzsx.cooco.net.cn#{path}"
      req.headers = {
        'Cookie' => cookie,
        'user-agent' => 'Mac Safari',
        'Host' => 'gzsx.cooco.net.cn'
      }
    end
    response.body
  end

  def download
    filepath = build
    puts "这里的filepath是#{filepath}"
    body = build(filepath)
    file_name = "#{@numbers.first} - #{@numbers.last} - #{filepath.split('/').last}"
    File.open(file_name, 'wb') { |fp| fp.write(body) }
  end
  
  def fetch_ids
    info = Cooco::CrawlerInfo.new()
    info.ids_for(@numbers).join('%2C')
  end

  

  private
  def set_cookie
    cookies = {
      coocoold: ['ad5ac34818bd4b755a27ebcc6ce6d74c', '.cooco.net.cn'],
      bdshare_firstime: ['1563612970002', 'gzsx.cooco.net.cn'],
      Hm_lpvt_c8ad39b9579b4816dc8f6f805c190308: ['1563784453', '.cooco.net.cn'],
      Hm_lvt_c8ad39b9579b4816dc8f6f805c190308: ['1563612961', '.cooco.net.cn'],
    }

    cookies.map(&->(key, value){
      puts "key is #{key}"
      HTTP::Cookie.new(key.to_s, value[0],
        domain:     value.last,
        for_domain: true,
        path:       '/'
      ).set_cookie_value
    })

    HTTP::Cookie.new("Cookie", new_cookie,
      domain:     'http://gzsx.cooco.net.cn',
      for_domain: true,
      path:       '/'
    ).set_cookie_value

    new_cookie
  end

  def new_cookie
    cookie = @cookie.split(';').map(&->(i){i.gsub(/\s+/, "")}).delete_if(&->(i){i.start_with?('gzsxtest')})
    cookie.push("gzsxtesttest=#{fetch_ids}").join(';')
  end
end